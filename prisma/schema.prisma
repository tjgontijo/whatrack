generator client {
  provider        = "prisma-client"
  output          = "./generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
}

// ============================================
// SEÇÃO 1: AUTENTICAÇÃO E USUÁRIOS
// ============================================

enum UserRole {
  owner
  admin
  user
}

enum OnboardingStatus {
  pending
  completed
  skipped
}

model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  phone         String?   @unique
  emailVerified Boolean?  @default(true)
  image         String?
  role          UserRole  @default(user)
  banned        Boolean   @default(false)
  banReason     String?
  banExpires    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  sessions Session[]
  accounts Account[]

  members     Member[]
  invitations Invitation[]

  @@map("user")
}

model Session {
  id             String   @id @default(cuid())
  expiresAt      DateTime
  token          String   @unique
  ipAddress      String?
  userAgent      String?
  impersonatedBy String?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  activeOrganizationId String?

  @@index([userId])
  @@map("session")
}

model Account {
  id         String @id @default(cuid())
  accountId  String
  providerId String
  userId     String
  user       User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@unique([providerId, accountId])
  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@map("verification")
}

// ============================================
// SEÇÃO 2: ORGANIZAÇÃO E MEMBROS
// ============================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  logo      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members                  Member[]
  invitations              Invitation[]
  leads                    Lead[]
  tickets                  Ticket[]
  sales                    Sale[]
  saleItems                SaleItem[]
  products                 Product[]
  productCategories        ProductCategory[]
  whatsappInstances        WhatsappInstance[]
  whatsappInstanceWebhooks WhatsappInstanceWebhook[]
  whatsappConversations    WhatsappConversation[]
  profile                  OrganizationProfile?
  company                  OrganizationCompany?

  @@map("organization")
}

model Member {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           String
  createdAt      DateTime

  @@map("member")
}

model Invitation {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String?
  status         String
  expiresAt      DateTime
  inviterId      String
  user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  @@map("invitation")
}

// ============================================
// SEÇÃO 3: CRM E LEADS
// ============================================

model Lead {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String?
  phone          String?
  remoteJid      String?      @map("remote_jid")
  mail           String?

  whatsappConversations WhatsappConversation[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  @@unique([organizationId, phone])
  @@unique([organizationId, remoteJid])
  @@index([organizationId])
  @@map("leads")
}

// ============================================
// SEÇÃO 4: WHATSAPP - CHAT E ATENDIMENTO
// ============================================

// Enums
enum ConversationStatus {
  OPEN
  PENDING
  RESOLVED
  SNOOZED
}

enum ConversationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum MessageSenderType {
  LEAD
  USER
  AI
  SYSTEM
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
}

enum WhatsappProvider {
  WUZAPI
  UAZAPI
  META_CLOUD
}

enum TicketStatus {
  OPEN
  RESOLVED
  FOLLOW_UP
}

enum TicketSourceType {
  paid
  organic
}

// Infrastructure
model WhatsappInstance {
  id             String                    @id @default(cuid())
  organizationId String
  organization   Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  instanceId     String
  token          String?
  label          String?
  phone          String?
  provider       WhatsappProvider          @default(WUZAPI)
  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @default(now()) @updatedAt
  webhooks       WhatsappInstanceWebhook[]

  @@unique([organizationId, instanceId], name: "organizationId_instanceId")
  @@index([organizationId])
  @@index([provider])
  @@map("whatsapp_instances")
}

model WhatsappInstanceWebhook {
  id                String           @id @default(cuid())
  organizationId    String
  organization      Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  instanceId        String
  instance          WhatsappInstance @relation(fields: [organizationId, instanceId], references: [organizationId, instanceId], onDelete: Cascade)
  providerWebhookId String?
  url               String
  secret            String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @default(now()) @updatedAt

  @@unique([organizationId, instanceId], name: "organizationId_instanceId_webhook")
  @@map("whatsapp_instance_webhook")
}

// Conversation Flow
model WhatsappConversation {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  leadId         String
  lead           Lead         @relation(fields: [leadId], references: [id], onDelete: Cascade)
  instanceId     String

  status   ConversationStatus   @default(OPEN)
  priority ConversationPriority @default(MEDIUM)

  unreadCount   Int       @default(0)
  lastMessageAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  tickets Ticket[]

  @@unique([leadId, instanceId])
  @@index([organizationId])
  @@index([instanceId])
  @@index([status])
  @@index([organizationId, status])
  @@index([organizationId, lastMessageAt])
  @@index([instanceId, status])
  @@map("whatsapp_conversations")
}

model WhatsappMessage {
  id       String @id @default(cuid())
  ticketId String
  ticket   Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  senderType MessageSenderType
  senderId   String?
  senderName String?

  messageType MessageType
  content     String?

  mediaUrl             String?
  mediaType            String?
  fileName             String?
  mediaSizeBytes       Int?
  mediaDurationSeconds Int?

  providerMessageId String? @unique

  status MessageStatus @default(PENDING)

  sentAt      DateTime
  deliveredAt DateTime?
  readAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([ticketId])
  @@index([sentAt])
  @@index([providerMessageId])
  @@index([ticketId, sentAt])
  @@index([ticketId, status])
  @@index([senderType, sentAt])
  @@map("whatsapp_messages")
}

// Tickets & Support
model Ticket {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  whatsappConversationId String
  whatsappConversation   WhatsappConversation @relation(fields: [whatsappConversationId], references: [id], onDelete: Cascade)

  status TicketStatus @default(OPEN)

  assigneeId   String?
  assigneeName String?

  resolvedAt DateTime?

  gclid    String?
  fbclid   String?
  ctwaclid String?

  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  utmTerm     String?
  utmContent  String?

  campaignId String? @map("campaign_id")
  adsetId    String? @map("adset_id")
  adId       String? @map("ad_id")

  sourceType TicketSourceType?
  platformId String?

  closedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  sales    Sale[]
  messages WhatsappMessage[]

  @@index([organizationId])
  @@index([whatsappConversationId])
  @@index([status])
  @@index([assigneeId])
  @@index([sourceType])
  @@index([campaignId])
  @@index([adsetId])
  @@index([adId])
  @@index([whatsappConversationId, status])
  @@index([organizationId, status, createdAt])
  @@map("tickets")
}

// ============================================
// SEÇÃO 5: VENDAS E PRODUTOS
// ============================================

enum SaleStatus {
  pending
  completed
  cancelled
}

model Sale {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  ticketId       String?
  ticket         Ticket?      @relation(fields: [ticketId], references: [id], onDelete: SetNull)

  totalAmount     Decimal?    @db.Decimal(12, 2)
  profit          Decimal?    @db.Decimal(12, 2)
  discount        Decimal?    @db.Decimal(12, 2)
  status          SaleStatus? @default(pending)
  notes           String?
  createdBy       String?
  updatedBy       String?
  statusChangedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  items SaleItem[]

  @@index([organizationId])
  @@index([ticketId])
  @@index([createdAt])
  @@map("sales")
}

model SaleItem {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  saleId String
  sale   Sale   @relation(fields: [saleId], references: [id], onDelete: Cascade)

  productId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  name      String
  quantity  Int     @default(1)
  unitPrice Decimal @db.Decimal(12, 2)
  total     Decimal @db.Decimal(12, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([organizationId])
  @@index([saleId])
  @@index([productId])
  @@map("sale_items")
}

model Product {
  id             String           @id @default(cuid())
  organizationId String
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  categoryId     String?
  category       ProductCategory? @relation(fields: [categoryId], references: [id])

  name   String
  price  Decimal? @db.Decimal(12, 2)
  cost   Decimal? @db.Decimal(12, 2)
  active Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  saleItems SaleItem[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([active])
  @@map("products")
}

model ProductCategory {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String
  active         Boolean      @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  products Product[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([active])
  @@map("product_categories")
}

// ============================================
// SEÇÃO 9: ORGANIZAÇÃO - PROFILE E DADOS
// ============================================

model OrganizationProfile {
  id             String       @id @default(cuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  cpf String? @unique

  onboardingStatus      OnboardingStatus @default(pending)
  onboardingCompletedAt DateTime?

  avgTicket       String?
  attendantsCount String?
  mainChannel     String?
  leadsPerDay     String?
  monthlyRevenue  String?
  monthlyAdSpend  String?

  estimatedConversionRate Float?
  estimatedCPL            Float?
  estimatedCAC            Float?
  estimatedROAS           Float?
  estimatedLeadValue      Float?
  leadsPerAttendant       Float?
  revenuePerAttendant     Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("organization_profiles")
}

// ============================================
// SEÇÃO 10: ORGANIZAÇÃO - COMPANY DATA
// ============================================

model OrganizationCompany {
  id             String       @id @default(cuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  cnpj            String  @unique
  razaoSocial     String
  nomeFantasia    String?
  cnaeCode        String
  cnaeDescription String
  municipio       String
  uf              String  @db.Char(2)

  tipo             String?
  porte            String?
  naturezaJuridica String?
  capitalSocial    Decimal?
  situacao         String?
  dataAbertura     DateTime?
  dataSituacao     DateTime?
  simplesOptante   Boolean   @default(false)
  simeiOptante     Boolean   @default(false)

  logradouro  String?
  numero      String?
  complemento String?
  bairro      String?
  cep         String?

  email    String?
  telefone String?

  qsa                   Json?
  atividadesSecundarias Json?

  authorizedByUserId String
  authorizedAt       DateTime @default(now())

  fetchedAt DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([cnaeCode])
  @@index([porte])
  @@index([uf])
  @@index([situacao])
  @@map("organization_companies")
}
