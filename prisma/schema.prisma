generator client {
  provider        = "prisma-client"
  output          = "./generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  owner
  admin
  user
}

enum TicketSourceType {
  paid
  organic
}

enum SaleStatus {
  pending
  completed
  cancelled
}

enum AppointmentStatus {
  scheduled
  cancelled
  completed
}

enum AttendanceStatus {
  showed
  no_show
}

enum PlatformEventType {
  lead
  contact
  purchase
  schedule
  conversion
}

enum PlatformEventStatus {
  sent
  failed
  pending
}

model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  phone         String?   @unique
  emailVerified Boolean?  @default(true)
  image         String?
  role          UserRole  @default(user)
  banned        Boolean   @default(false)
  banReason     String?
  banExpires    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  sessions Session[]
  accounts Account[]

  members      Member[]
  invitations  Invitation[]
  dailyMetrics UserDailyMetrics[]

  @@map("user")
}

model Session {
  id             String   @id @default(cuid())
  expiresAt      DateTime
  token          String   @unique
  ipAddress      String?
  userAgent      String?
  impersonatedBy String?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  activeOrganizationId String?

  @@index([userId])
  @@map("session")
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  logo      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members                  Member[]
  invitations              Invitation[]
  leads                    Lead[]
  tickets                  Ticket[]
  sales                    Sale[]
  saleItems                SaleItem[]
  products                 Product[]
  productCategories        ProductCategory[]
  appointments             Appointment[]
  attendances              Attendance[]
  platformEvents           PlatformEvent[]
  salesAnalytics           SalesAnalytics[]
  metaAdsMetrics           MetaAdsMetric[]
  whatsappInstances        WhatsappInstance[]
  whatsappInstanceWebhooks WhatsappInstanceWebhook[]
  whatsappMessages         WhatsappMessage[]
  conversations            Conversation[]

  // Billing
  currentPlanId   String?
  currentPlan     Plan?            @relation(fields: [currentPlanId], references: [id])
  billingCustomer BillingCustomer?

  // AI Credits
  aiCredits AICredits?

  // Follow-up Config
  followUpConfig FollowUpConfig?

  // Dados de negócio
  profile OrganizationProfile?
  company OrganizationCompany?

  // Analytics Metrics
  dailyMetrics DailyMetrics[]

  @@index([currentPlanId])
  @@map("organization")
}

model Member {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           String
  createdAt      DateTime

  @@map("member")
}

model Invitation {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String?
  status         String
  expiresAt      DateTime
  inviterId      String
  user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  @@map("invitation")
}

model Account {
  id         String @id @default(cuid())
  accountId  String
  providerId String
  userId     String
  user       User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@unique([providerId, accountId])
  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@map("verification")
}

model Lead {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String?
  phone          String?
  remoteJid      String?      @map("remote_jid")
  instagram      String?
  mail           String?
  firstTicketId  String?
  firstSource    String?
  firstCampaign  String?
  firstMedium    String?

  assignedTo String?
  notes      String? @db.Text
  status     String? @default("new")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  tickets          Ticket[]
  salesAnalytics   SalesAnalytics[]
  whatsappMessages WhatsappMessage[]
  conversations    Conversation[]

  @@unique([organizationId, phone])
  @@unique([organizationId, remoteJid])
  @@index([organizationId])
  @@map("leads")
}

model Ticket {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  status TicketStatus @default(OPEN)

  assigneeId   String?
  assigneeName String?

  resolvedAt DateTime?

  followUpEnabled     Boolean @default(false)
  currentFollowUpStep Int?

  leadId String?
  lead   Lead?   @relation(fields: [leadId], references: [id], onDelete: SetNull)

  gclid    String?
  fbclid   String?
  ctwaclid String?

  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  utmTerm     String?
  utmContent  String?

  campaignId String? @map("campaign_id")
  adsetId    String? @map("adset_id")
  adId       String? @map("ad_id")

  sourceType TicketSourceType?
  platformId String?

  lastMessageAt DateTime?
  closedAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  sales             Sale[]
  whatsappMessages  WhatsappMessage[]
  events            PlatformEvent[]
  analytics         SalesAnalytics?
  appointments      Appointment[]
  messages          Message[]
  scheduledMessages ScheduledMessage[]
  analysis          TicketAnalysis?

  @@index([organizationId])
  @@index([conversationId])
  @@index([status])
  @@index([assigneeId])
  @@index([leadId])
  @@index([sourceType])
  @@index([lastMessageAt])
  @@index([campaignId])
  @@index([adsetId])
  @@index([adId])
  @@map("tickets")
}

model Sale {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  ticketId       String?
  ticket         Ticket?      @relation(fields: [ticketId], references: [id], onDelete: SetNull)

  totalAmount     Decimal?    @db.Decimal(12, 2)
  profit          Decimal?    @db.Decimal(12, 2)
  discount        Decimal?    @db.Decimal(12, 2)
  status          SaleStatus? @default(pending)
  notes           String?
  createdBy       String?
  updatedBy       String?
  statusChangedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  items  SaleItem[]
  events PlatformEvent[]

  @@index([organizationId])
  @@index([ticketId])
  @@index([createdAt])
  @@map("sales")
}

model SaleItem {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  saleId String
  sale   Sale   @relation(fields: [saleId], references: [id], onDelete: Cascade)

  productId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  name      String
  quantity  Int     @default(1)
  unitPrice Decimal @db.Decimal(12, 2)
  total     Decimal @db.Decimal(12, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([organizationId])
  @@index([saleId])
  @@index([productId])
  @@map("sale_items")
}

model Product {
  id             String           @id @default(cuid())
  organizationId String
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  categoryId     String?
  category       ProductCategory? @relation(fields: [categoryId], references: [id])

  name   String
  price  Decimal? @db.Decimal(12, 2)
  cost   Decimal? @db.Decimal(12, 2)
  active Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  saleItems SaleItem[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([active])
  @@map("products")
}

model ProductCategory {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String
  active         Boolean      @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  products Product[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([active])
  @@map("product_categories")
}

model Appointment {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  ticketId       String?
  ticket         Ticket?      @relation(fields: [ticketId], references: [id], onDelete: SetNull)

  scheduledFor DateTime
  status       AppointmentStatus @default(scheduled)
  notes        String?

  attendance Attendance?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([organizationId])
  @@index([ticketId])
  @@map("appointments")
}

model Attendance {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  appointmentId  String       @unique
  appointment    Appointment  @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  status AttendanceStatus
  notes  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([organizationId])
  @@map("attendance")
}

model PlatformEvent {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  ticketId String?
  ticket   Ticket? @relation(fields: [ticketId], references: [id], onDelete: SetNull)

  saleId String?
  sale   Sale?   @relation(fields: [saleId], references: [id], onDelete: SetNull)

  platform   String
  eventType  PlatformEventType
  externalId String?
  status     PlatformEventStatus?
  payload    Json?
  response   Json?
  sentAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([ticketId])
  @@index([saleId])
  @@index([platform])
  @@index([eventType])
  @@index([externalId])
  @@map("platform_events")
}

model SalesAnalytics {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  ticketId       String?      @unique
  ticket         Ticket?      @relation(fields: [ticketId], references: [id], onDelete: SetNull)

  leadId String?
  lead   Lead?   @relation(fields: [leadId], references: [id], onDelete: SetNull)

  qualyAudit String?
  timeAudit  String?
  metadata   Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([organizationId])
  @@index([ticketId])
  @@index([leadId])
  @@map("sales_analytics")
}

model MetaAdsMetric {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  reportDate     DateTime     @map("report_date")
  campaign       String       @map("campaign_name")
  campaignId     String       @map("campaign_id")
  adset          String       @map("adset_name")
  adsetId        String       @map("adset_id")
  ad             String       @map("ad_name")
  adId           String       @map("ad_id")
  impressions    Int
  clicks         Int
  results        Int
  cost           Decimal      @db.Decimal(12, 2)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  @@unique([organizationId, reportDate, campaignId, adsetId, adId])
  @@index([organizationId])
  @@map("meta_ads_metrics")
}

model WhatsappInstance {
  id             String                    @id @default(cuid())
  organizationId String
  organization   Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  instanceId     String
  token          String?
  label          String?
  phone          String?
  provider       String                    @default("wuzapi") // wuzapi, uazapi, meta_cloud
  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @default(now()) @updatedAt
  webhooks       WhatsappInstanceWebhook[]

  @@unique([organizationId, instanceId], name: "organizationId_instanceId")
  @@index([organizationId])
  @@index([provider])
  @@map("whatsapp_instances")
}

model WhatsappInstanceWebhook {
  id                String           @id @default(cuid())
  organizationId    String
  organization      Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  instanceId        String
  instance          WhatsappInstance @relation(fields: [organizationId, instanceId], references: [organizationId, instanceId], onDelete: Cascade)
  providerWebhookId String?
  url               String
  secret            String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @default(now()) @updatedAt

  @@unique([organizationId, instanceId], name: "organizationId_instanceId_webhook")
  @@map("whatsapp_instance_webhook")
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

model WhatsappMessage {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  instanceId     String

  leadId   String?
  lead     Lead?   @relation(fields: [leadId], references: [id], onDelete: SetNull)
  ticketId String?
  ticket   Ticket? @relation(fields: [ticketId], references: [id], onDelete: SetNull)

  remoteJid            String
  direction            MessageDirection
  providerMessageId    String
  messageType          String
  mediaType            String
  contentText          String
  mediaUrl             String?
  mediaMimeType        String?
  mediaSizeBytes       Int?
  mediaDurationSeconds Int?
  sentAt               DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@unique([organizationId, providerMessageId], name: "organization_message_unique")
  @@index([organizationId])
  @@index([leadId])
  @@index([ticketId])
  @@index([remoteJid])
  @@index([sentAt])
  @@map("whatsapp_message")
}

// Inbox/Conversation models
enum ConversationStatus {
  OPEN
  PENDING
  RESOLVED
  SNOOZED
}

enum ConversationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum MessageSenderType {
  LEAD
  USER
  AI
  SYSTEM
}

enum TicketStatus {
  OPEN
  RESOLVED
  FOLLOW_UP
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
}

// ============================================
// WHATSAPP CAMPAIGNS ENUMS
// ============================================

enum TemplateCategory {
  MARKETING
  UTILITY
  AUTHENTICATION
}

enum TemplateStatus {
  APPROVED
  PENDING
  REJECTED
  PAUSED
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum CreditTransactionType {
  PURCHASE
  CAMPAIGN_USE
  REFUND
  ADJUSTMENT
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
}

/// Conversation threads - 1:1 with Lead
model Conversation {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Lead relationship (N:1 - múltiplas conversas por lead em diferentes instâncias)
  leadId String
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  // WhatsApp instance
  instanceId String

  status   ConversationStatus   @default(OPEN)
  priority ConversationPriority @default(MEDIUM)

  unreadCount   Int       @default(0)
  lastMessageAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  tickets Ticket[]
  metrics ConversationMetrics?

  // Unique por (leadId, instanceId) - permite múltiplas conversas por lead em diferentes instâncias
  @@unique([leadId, instanceId])
  @@index([organizationId])
  @@index([instanceId])
  @@index([status])
  @@map("conversations")
}

/// AI Analysis of a ticket
model TicketAnalysis {
  id       String @id @default(cuid())
  ticketId String @unique
  ticket   Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  // Sentiment analysis
  sentiment      String? // "positive", "neutral", "negative", "frustrated"
  sentimentScore Float? // -1.0 to 1.0

  // Signals detected during conversation
  buyingSignals    String[] // ["askedPrice", "mentionedTimeline", ...]
  objectionSignals String[] // ["priceObjection", "delayTactic", ...]

  // AI-calculated Lead Score
  aiLeadScore  Int? // 0-100
  scoreFactors Json? // { engagement, intent, urgency, budget }

  // Insights
  summary String?  @db.Text // Summary in 1-2 sentences
  tags    String[] // Inferred tags ["urgente", "empresa", "preço"]

  // Outcome (filled when ticket closes)
  outcome       String? // "sale", "lost_price", "lost_competitor", "lost_timing", "lost_need", "abandoned"
  outcomeReason String? @db.Text // Detailed explanation

  // Tracking
  analyzedAt   DateTime // When analysis was performed
  messageCount Int // How many messages were analyzed
  creditsUsed  Int      @default(2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("ticket_analyses")
}

/// Conversation Metrics - Aggregated stats for a conversation
model ConversationMetrics {
  id             String       @id @default(cuid())
  conversationId String       @unique
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // Response times (in milliseconds)
  leadAvgResponseTime  Int?
  agentAvgResponseTime Int?
  leadFastestResponse  Int?

  // Message counts
  messagesFromLead  Int @default(0)
  messagesFromAgent Int @default(0)
  totalMessages     Int @default(0)
  mediaShared       Int @default(0)

  // Engagement metrics
  avgMessageLength     Int?
  conversationDuration Int? // ms since first message

  // Basic lead score (0-100, based on engagement)
  basicLeadScore Int?

  // Timestamps
  lastLeadMessageAt  DateTime?
  lastAgentMessageAt DateTime?

  updatedAt DateTime @updatedAt

  @@map("conversation_metrics")
}

/// Messages in tickets
model Message {
  id       String @id @default(cuid())
  ticketId String
  ticket   Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  senderType MessageSenderType
  senderId   String?
  senderName String?

  messageType String // TEXT, IMAGE, VIDEO, AUDIO, DOCUMENT
  content     String?

  mediaUrl             String?
  mediaType            String?
  fileName             String?
  mediaSizeBytes       Int?
  mediaDurationSeconds Int?

  providerMessageId String? @unique

  status MessageStatus @default(PENDING)

  sentAt      DateTime
  deliveredAt DateTime?
  readAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([ticketId])
  @@index([sentAt])
  @@index([providerMessageId])
  @@map("messages")
}

// ============================================
// BILLING MODELS
// ============================================

enum PlanInterval {
  monthly
  yearly
}

enum SubscriptionStatus {
  incomplete
  trialing
  active
  past_due
  unpaid
  canceled
  paused
}

enum PaymentStatus {
  pending
  processing
  succeeded
  failed
  refunded
  canceled
}

enum PaymentMethod {
  credit_card
  debit_card
  pix
  boleto
  bank_transfer
  wallet
}

enum BillingProvider {
  asaas
  stripe
  mercadopago
  manual
}

model Plan {
  id          String  @id @default(cuid())
  name        String  @unique // "Free", "Starter", "Pro", "Business"
  slug        String  @unique // "free", "starter", "pro", "business"
  description String?
  isActive    Boolean @default(true)
  sortOrder   Int     @default(0)

  // Limites do plano
  maxMetaProfiles      Int  @default(0)
  maxMetaAdAccounts    Int  @default(0)
  maxWhatsappInstances Int  @default(1)
  maxMembers           Int  @default(1)
  maxLeadsPerMonth     Int? // null = ilimitado
  maxMessagesPerMonth  Int? // null = ilimitado

  // WhatsApp - Retenção de mensagens
  messageRetentionDays Int? // null = ilimitado, 7, 30, 90, 365
  maxMessagesStored    Int? // null = ilimitado

  // AI Credits quota per billing cycle
  aiCreditsQuota Int @default(0) // Free=0, Starter=100, Pro=500, Business=1500, Enterprise=5000

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  prices        PlanPrice[]
  subscriptions Subscription[]
  organizations Organization[]

  @@map("plans")
}

model PlanPrice {
  id     String @id @default(cuid())
  planId String
  plan   Plan   @relation(fields: [planId], references: [id], onDelete: Cascade)

  provider    BillingProvider // asaas, stripe
  currency    String // BRL, USD
  interval    PlanInterval // monthly, yearly
  amountCents Int // Valor em centavos (R$97 = 9700)

  // External IDs (para lookup reverso)
  externalPriceId   String? // price_xxx no Stripe
  externalProductId String? // prod_xxx no Stripe

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@unique([planId, provider, currency, interval])
  @@index([provider])
  @@map("plan_prices")
}

model BillingCustomer {
  id             String       @id @default(cuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Dados do cliente
  email   String
  name    String?
  taxId   String? // CPF ou CNPJ
  phone   String?
  address Json? // { street, number, city, state, zipCode, country }

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  externalCustomers BillingCustomerExternal[]
  paymentMethods    PaymentMethodStored[]
  subscriptions     Subscription[]
  invoices          Invoice[]
  payments          Payment[]

  @@map("billing_customers")
}

model BillingCustomerExternal {
  id                String          @id @default(cuid())
  billingCustomerId String
  billingCustomer   BillingCustomer @relation(fields: [billingCustomerId], references: [id], onDelete: Cascade)

  provider   BillingProvider
  externalId String // cus_xxx no Asaas/Stripe

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@unique([billingCustomerId, provider])
  @@unique([provider, externalId])
  @@map("billing_customer_externals")
}

model PaymentMethodStored {
  id                String          @id @default(cuid())
  billingCustomerId String
  billingCustomer   BillingCustomer @relation(fields: [billingCustomerId], references: [id], onDelete: Cascade)

  provider   BillingProvider
  externalId String // pay_xxx, card_xxx

  type           PaymentMethod // credit_card, pix, boleto
  lastFourDigits String? // "4242"
  brand          String? // "visa", "mastercard"
  expiryMonth    Int?
  expiryYear     Int?

  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@unique([provider, externalId])
  @@index([billingCustomerId])
  @@map("payment_methods_stored")
}

model Subscription {
  id                String          @id @default(cuid())
  billingCustomerId String
  billingCustomer   BillingCustomer @relation(fields: [billingCustomerId], references: [id], onDelete: Cascade)

  planId String
  plan   Plan   @relation(fields: [planId], references: [id])

  // Provider
  provider   BillingProvider
  externalId String? // sub_xxx

  // Status
  status SubscriptionStatus @default(incomplete)

  // Período
  interval           PlanInterval
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean      @default(false)
  canceledAt         DateTime?
  endedAt            DateTime?

  // Trial
  trialStart DateTime?
  trialEnd   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  invoices Invoice[]

  @@unique([provider, externalId])
  @@index([billingCustomerId])
  @@index([status])
  @@map("subscriptions")
}

model Invoice {
  id                String          @id @default(cuid())
  billingCustomerId String
  billingCustomer   BillingCustomer @relation(fields: [billingCustomerId], references: [id], onDelete: Cascade)

  subscriptionId String?
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)

  // Provider
  provider   BillingProvider
  externalId String? // inv_xxx

  // Valores
  subtotalCents Int
  discountCents Int    @default(0)
  taxCents      Int    @default(0)
  totalCents    Int
  currency      String @default("BRL")

  // Status
  status  PaymentStatus @default(pending)
  dueDate DateTime?
  paidAt  DateTime?

  // Metadata
  description String?
  metadata    Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  items    InvoiceItem[]
  payments Payment[]

  @@unique([provider, externalId])
  @@index([billingCustomerId])
  @@index([subscriptionId])
  @@index([status])
  @@map("invoices")
}

/// Itens da fatura
model InvoiceItem {
  id        String  @id @default(cuid())
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  description String
  quantity    Int    @default(1)
  unitCents   Int
  totalCents  Int

  createdAt DateTime @default(now())

  @@index([invoiceId])
  @@map("invoice_items")
}

/// Pagamento realizado
model Payment {
  id                String          @id @default(cuid())
  billingCustomerId String
  billingCustomer   BillingCustomer @relation(fields: [billingCustomerId], references: [id], onDelete: Cascade)

  invoiceId String?
  invoice   Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  // Provider
  provider   BillingProvider
  externalId String? // pay_xxx

  // Valores
  amountCents Int
  currency    String @default("BRL")

  // Status
  status     PaymentStatus  @default(pending)
  method     PaymentMethod?
  paidAt     DateTime?
  failedAt   DateTime?
  refundedAt DateTime?

  // Método específico
  pixQrCode     String?   @db.Text
  pixCopyPaste  String?   @db.Text
  pixExpiresAt  DateTime?
  boletoUrl     String?
  boletoBarcode String?
  boletoDueDate DateTime?
  cardLastFour  String?
  cardBrand     String?

  // Metadata
  failureReason String?
  metadata      Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@unique([provider, externalId])
  @@index([billingCustomerId])
  @@index([invoiceId])
  @@index([status])
  @@map("payments")
}

/// Eventos de webhook processados (idempotência)
model WebhookEvent {
  id String @id @default(cuid())

  provider  BillingProvider
  eventId   String // Unique event ID from provider
  eventType String // "payment.confirmed", "subscription.canceled"

  // Processing
  processed   Boolean   @default(false)
  processedAt DateTime?
  error       String?

  // Payload
  payload Json

  createdAt DateTime @default(now())

  @@unique([provider, eventId])
  @@index([provider, eventType])
  @@index([processed])
  @@map("webhook_events")
}

// ============================================
// ORGANIZATION PROFILE (Dados de Negócio/Onboarding)
// ============================================

/// Perfil e dados de negócio da organização
model OrganizationProfile {
  id             String       @id @default(cuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Identificação (CPF para quem não tem CNPJ)
  cpf String? @unique

  // Onboarding
  onboardingCompleted   Boolean   @default(false)
  onboardingCompletedAt DateTime?

  // Métricas de negócio (coletadas no onboarding)
  avgTicket       String?
  attendantsCount String?
  mainChannel     String?
  leadsPerDay     String?
  monthlyRevenue  String?
  monthlyAdSpend  String?

  // Métricas calculadas
  estimatedConversionRate Float?
  estimatedCPL            Float?
  estimatedCAC            Float?
  estimatedROAS           Float?
  estimatedLeadValue      Float?
  leadsPerAttendant       Float?
  revenuePerAttendant     Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("organization_profiles")
}

// ============================================
// COMPANY DATA (CNPJ/ReceitaWS)
// ============================================

/// Dados da empresa vinculada à organização (via ReceitaWS)
model OrganizationCompany {
  id             String       @id @default(cuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // === CAMPOS EXIBIDOS NO FRONTEND ===
  cnpj            String  @unique
  razaoSocial     String
  nomeFantasia    String?
  cnaeCode        String // atividade_principal.code
  cnaeDescription String // atividade_principal.text
  municipio       String
  uf              String  @db.Char(2)

  // === CAMPOS PARA BI (não exibidos) ===
  tipo             String? // MATRIZ, FILIAL
  porte            String? // MICRO EMPRESA, EPP, etc
  naturezaJuridica String?
  capitalSocial    Decimal?
  situacao         String? // ATIVA, BAIXADA
  dataAbertura     DateTime?
  dataSituacao     DateTime?
  simplesOptante   Boolean   @default(false)
  simeiOptante     Boolean   @default(false)

  // Endereço completo
  logradouro  String?
  numero      String?
  complemento String?
  bairro      String?
  cep         String?

  // Contato
  email    String?
  telefone String?

  // Sócios e atividades secundárias (JSON)
  qsa                   Json? // Array de sócios
  atividadesSecundarias Json? // Array de CNAEs

  // Autorização/Compliance
  authorizedByUserId String
  authorizedAt       DateTime @default(now())

  // Controle
  fetchedAt DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([cnaeCode])
  @@index([porte])
  @@index([uf])
  @@index([situacao])
  @@map("organization_companies")
}

// ============================================
// AI CREDITS MODELS
// ============================================

/// AI Credits balance per organization
model AICredits {
  id             String       @id @default(cuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  balance       Int @default(0) // Accumulated balance
  usedThisCycle Int @default(0) // Used in current billing cycle

  // Tracking
  lastCreditedAt DateTime? // Last time credits were added

  // For reactivation (win-back campaign)
  balanceAtCancellation Int? // Balance at cancellation
  canceledAt            DateTime? // Cancellation date

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  usageLogs AIUsageLog[]

  @@map("ai_credits")
}

/// AI Usage Log - tracks each AI action
model AIUsageLog {
  id             String    @id @default(cuid())
  organizationId String
  aiCreditsId    String
  aiCredits      AICredits @relation(fields: [aiCreditsId], references: [id], onDelete: Cascade)

  // Action
  action      String // "followup_generation", "ticket_analysis", "response_suggestion"
  creditsUsed Int

  // Context
  ticketId     String? // Reference to ticket
  contactPhone String? // Lead phone for audit

  // Technical metadata
  model        String? // "gemini-2.0-flash", "llama-3.3-70b"
  inputTokens  Int?
  outputTokens Int?
  latencyMs    Int?

  // Who triggered
  triggeredBy String // "system" or "user:{userId}"

  createdAt DateTime @default(now())

  @@index([organizationId, createdAt])
  @@index([aiCreditsId])
  @@map("ai_usage_logs")
}

// ============================================
// SCHEDULED MESSAGES MODELS
// ============================================

model ScheduledMessage {
  id             String @id @default(cuid())
  organizationId String
  ticketId       String
  ticket         Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  step    Int // 1, 2, 3...
  content String? // Filled when sent (AI-generated content)

  scheduledAt  DateTime
  sentAt       DateTime?
  cancelledAt  DateTime?
  cancelReason String? // "lead_replied", "manual", "no_credits", "business_hours"

  bullJobId   String? // For BullMQ job cancellation
  creditsUsed Int     @default(1)

  createdAt DateTime @default(now())

  @@index([ticketId])
  @@index([organizationId])
  @@index([scheduledAt, sentAt])
  @@map("scheduled_messages")
}

model FollowUpConfig {
  id             String       @id @default(cuid())
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  isActive Boolean @default(true)

  // Business hours
  businessHoursOnly Boolean @default(true)
  businessStartHour Int     @default(9) // 09:00
  businessEndHour   Int     @default(18) // 18:00
  businessDays      Int[]   @default([1, 2, 3, 4, 5]) // Mon-Fri (0=Sun, 6=Sat)

  // AI configuration
  aiTone             String  @default("professional") // professional, friendly, urgent
  businessType       String? // e.g., "software company"
  productDescription String? // e.g., "CRM for WhatsApp"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  steps FollowUpStep[]

  @@map("followup_configs")
}

model FollowUpStep {
  id       String         @id @default(cuid())
  configId String
  config   FollowUpConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  order        Int // 1, 2, 3...
  delayMinutes Int // Delay from last interaction

  createdAt DateTime @default(now())

  @@unique([configId, order])
  @@map("followup_steps")
}

// ============================================
// DAILY METRICS MODELS
// ============================================

model DailyMetrics {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  date DateTime @db.Date

  // Tickets/Conversations
  ticketsOpened    Int @default(0)
  ticketsClosed    Int @default(0)
  ticketsWon       Int @default(0)
  ticketsLost      Int @default(0)
  ticketsAbandoned Int @default(0)

  // Sales
  salesCount   Int     @default(0)
  salesRevenue Decimal @default(0) @db.Decimal(12, 2)

  // Loss reasons (from TicketAnalysis)
  lostByPrice      Int @default(0)
  lostByCompetitor Int @default(0)
  lostByTiming     Int @default(0)
  lostByNeed       Int @default(0)

  // Leads
  newLeads       Int @default(0)
  returningLeads Int @default(0)

  // Appointments
  appointmentsCreated Int @default(0)
  appointmentsShowed  Int @default(0)
  appointmentsNoShow  Int @default(0)

  // Engagement
  messagesReceived  Int  @default(0)
  messagesSent      Int  @default(0)
  avgResponseTimeMs Int?

  // AI Scores
  avgLeadScore      Float?
  avgSentimentScore Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, date])
  @@index([organizationId, date])
  @@map("daily_metrics")
}

model UserDailyMetrics {
  id             String @id @default(cuid())
  organizationId String
  userId         String
  user           User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  date DateTime @db.Date

  ticketsAssigned Int @default(0)
  ticketsClosed   Int @default(0)
  ticketsWon      Int @default(0)

  salesCount   Int     @default(0)
  salesRevenue Decimal @default(0) @db.Decimal(12, 2)

  messagesSent      Int    @default(0)
  avgResponseTimeMs Int?
  avgSentimentScore Float?

  createdAt DateTime @default(now())

  @@unique([organizationId, userId, date])
  @@index([organizationId, date])
  @@map("user_daily_metrics")
}
