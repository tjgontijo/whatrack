generator client {
  provider        = "prisma-client-js"
  output          = "./generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [pgcrypto]
}

// ============================================
// SEÇÃO 0: TABELAS DE REFERÊNCIA (ENUMS DINÂMICOS)
// ============================================

model UserRole {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String   @unique
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users User[]

  @@map("user_roles")
}

model OnboardingStatus {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String   @unique
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  profiles OrganizationProfile[]

  @@map("onboarding_statuses")
}

model SaleStatus {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String   @unique
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  sales Sale[]

  @@map("sale_statuses")
}

model WhatsAppOnboardingStatus {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String   @unique
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  onboardings WhatsAppOnboarding[]

  @@map("whatsapp_onboarding_statuses")
}

model WhatsAppConnectionStatus {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String   @unique
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  connections WhatsAppConnection[]

  @@map("whatsapp_connection_statuses")
}

model WhatsAppHealthStatus {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String   @unique
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  connections WhatsAppConnection[] @relation("ConnectionHealthStatus")
  healthChecks WhatsAppHealth[] @relation("HealthStatus")

  @@map("whatsapp_health_statuses")
}

model WhatsAppAuditAction {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String   @unique
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  auditLogs WhatsAppAuditLog[]

  @@map("whatsapp_audit_actions")
}

// ============================================
// SEÇÃO 1: AUTENTICAÇÃO E USUÁRIOS
// ============================================

model User {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String
  email         String    @unique
  phone         String?   @unique
  emailVerified Boolean?  @default(true)
  image         String?
  role          String    @default("user")
  roleRef       UserRole  @relation(fields: [role], references: [name])
  banned        Boolean   @default(false)
  banReason     String?
  banExpires    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  sessions Session[]
  accounts Account[]

  members     Member[]
  invitations Invitation[]
  assignedTickets Ticket[] @relation("TicketAssignee")

  @@map("user")
}

model Session {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  expiresAt      DateTime
  token          String   @unique
  ipAddress      String?
  userAgent      String?
  impersonatedBy String?

  userId String @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  activeOrganizationId String? @db.Uuid

  @@index([userId])
  @@map("session")
}

model Account {
  id         String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  accountId  String
  providerId String
  userId     String @db.Uuid
  user       User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@unique([providerId, accountId])
  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  identifier String
  value      String
  expiresAt  DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@map("verification")
}

// ============================================
// SEÇÃO 2: ORGANIZAÇÃO E MEMBROS
// ============================================

model Organization {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  slug      String   @unique
  logo      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members           Member[]
  invitations       Invitation[]
  leads             Lead[]
  conversations     Conversation[]
  tickets           Ticket[]
  ticketStages      TicketStage[]
  sales             Sale[]
  saleItems         SaleItem[]
  products          Product[]
  productCategories ProductCategory[]
  profile           OrganizationProfile?
  company           OrganizationCompany?
  whatsappConfig    WhatsAppConfig[]
  whatsappOnboardings WhatsAppOnboarding[] @relation("WhatsAppOnboardings")
  whatsappConnections WhatsAppConnection[] @relation("WhatsAppConnections")
  whatsappHealthChecks WhatsAppHealth[] @relation("WhatsAppHealthChecks")
  webhookLogs       WhatsAppWebhookLog[] @relation("WhatsAppWebhookLogs")
  whatsappAuditLogs WhatsAppAuditLog[] @relation("WhatsAppAuditLogs")

  @@map("organization")
}

model Member {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String @db.Uuid
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String @db.Uuid
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           String
  createdAt      DateTime

  @@map("member")
}

model Invitation {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String @db.Uuid
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String?
  status         String
  expiresAt      DateTime
  inviterId      String @db.Uuid
  user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  @@map("invitation")
}

// ============================================
// SEÇÃO 3: CRM E LEADS
// ============================================

model Lead {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String @db.Uuid
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Basic Info
  name           String?
  mail           String?
  phone          String?      // International format: +5511999998888

  // WhatsApp Specific
  waId           String?      @map("remote_jid") // Meta technical ID
  pushName       String?      // WhatsApp profile name
  profilePicUrl  String?

  // Chat Control
  lastMessageAt  DateTime?    @map("last_message_at")

  // Source Tracking - PRD: History Sync
  source         String       @default("direct_creation") // 'direct_creation' | 'live_message' | 'history_sync' | 'state_sync'
  lastSyncedAt   DateTime?    // Last time synced from history/state_sync
  isActive       Boolean      @default(true)
  deletedAt      DateTime?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  conversations Conversation[]
  messages  Message[]
  tickets   Ticket[]

  @@unique([organizationId, phone])
  @@unique([organizationId, waId])
  @@index([organizationId])
  @@index([source])
  @@index([isActive])
  @@map("leads")
}

// ============================================
// SEÇÃO 3B: TICKETS E CONVERSAS
// ============================================

model Conversation {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String   @db.Uuid
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  leadId         String   @db.Uuid
  lead           Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  instanceId     String   @db.Uuid
  instance       WhatsAppConfig @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  metaConversationId String?

  messagesCount  Int      @default(0)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  messages       Message[]
  tickets        Ticket[]

  @@unique([leadId, instanceId])
  @@index([organizationId])
  @@map("conversations")
}

model Ticket {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String   @db.Uuid
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  leadId         String   @db.Uuid
  lead           Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  conversationId String   @db.Uuid
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  stageId        String   @db.Uuid
  stage          TicketStage @relation(fields: [stageId], references: [id])

  windowExpiresAt DateTime?
  windowOpen      Boolean  @default(true)

  assigneeId     String?  @db.Uuid
  assignee       User?    @relation("TicketAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)

  dealValue      Decimal? @db.Decimal(12, 2)

  status         String   @default("open")
  closedAt       DateTime?
  closedReason   String?

  createdBy      String   @default("SYSTEM")
  messagesCount  Int      @default(0)

  // Source Tracking - PRD: History Sync
  source         String   @default("incoming_message") // 'incoming_message' | 'api' | 'manual'
  originatedFrom String?  // 'new_contact' | 'history_lead' | 'existing'

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tracking       TicketTracking?
  messages       Message[]
  sales          Sale[]

  @@index([organizationId])
  @@index([conversationId])
  @@index([status])
  @@index([stageId])
  @@index([source])
  @@index([originatedFrom])
  @@index([windowExpiresAt])
  @@map("tickets")
}

model TicketStage {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String   @db.Uuid
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name           String
  color          String
  order          Int
  isDefault      Boolean  @default(false)
  isClosed       Boolean  @default(false)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tickets        Ticket[]

  @@unique([organizationId, name])
  @@index([organizationId, order])
  @@map("ticket_stages")
}

model TicketTracking {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ticketId       String   @unique @db.Uuid
  ticket         Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  utmSource      String?
  utmMedium      String?
  utmCampaign    String?
  utmTerm        String?
  utmContent     String?

  gclid          String?
  fbclid         String?
  ctwaclid       String?
  ttclid         String?

  sourceType     String   @default("organic")
  referrerUrl    String?
  landingPage    String?

  userAgent      String?
  ipAddress      String?

  createdAt      DateTime @default(now())

  @@index([utmSource])
  @@index([sourceType])
  @@index([ctwaclid])
  @@map("ticket_tracking")
}

// ============================================
// SEÇÃO 4: VENDAS E PRODUTOS
// ============================================

model Sale {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String @db.Uuid
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  totalAmount     Decimal?    @db.Decimal(12, 2)
  profit          Decimal?    @db.Decimal(12, 2)
  discount        Decimal?    @db.Decimal(12, 2)
  status          String?   @default("pending")
  statusRef       SaleStatus? @relation(fields: [status], references: [name])
  notes           String?
  createdBy       String?
  updatedBy       String?
  statusChangedAt DateTime?
  ticketId        String?    @db.Uuid
  ticket          Ticket?    @relation(fields: [ticketId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  items SaleItem[]

  @@index([organizationId])
  @@index([createdAt])
  @@index([ticketId])
  @@map("sales")
}

model SaleItem {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String @db.Uuid
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  saleId String @db.Uuid
  sale   Sale   @relation(fields: [saleId], references: [id], onDelete: Cascade)

  productId String? @db.Uuid
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  name      String
  quantity  Int     @default(1)
  unitPrice Decimal @db.Decimal(12, 2)
  total     Decimal @db.Decimal(12, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([organizationId])
  @@index([saleId])
  @@index([productId])
  @@map("sale_items")
}

model Product {
  id             String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String @db.Uuid
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  categoryId     String? @db.Uuid
  category       ProductCategory? @relation(fields: [categoryId], references: [id])

  name   String
  price  Decimal? @db.Decimal(12, 2)
  cost   Decimal? @db.Decimal(12, 2)
  active Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  saleItems SaleItem[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([active])
  @@map("products")
}

model ProductCategory {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String @db.Uuid
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String
  active         Boolean      @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  products Product[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([active])
  @@map("product_categories")
}

// ============================================
// SEÇÃO 5: ORGANIZAÇÃO - PROFILE E DADOS
// ============================================

model OrganizationProfile {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String       @unique @db.Uuid
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  cpf String? @unique

  onboardingStatus      String @default("pending")
  onboardingStatusRef   OnboardingStatus @relation(fields: [onboardingStatus], references: [name])
  onboardingCompletedAt DateTime?

  avgTicket       String?
  attendantsCount String?
  mainChannel     String?
  leadsPerDay     String?
  monthlyRevenue  String?
  monthlyAdSpend  String?

  estimatedConversionRate Float?
  estimatedCPL            Float?
  estimatedCAC            Float?
  estimatedROAS           Float?
  estimatedLeadValue      Float?
  leadsPerAttendant       Float?
  revenuePerAttendant     Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("organization_profiles")
}

// ============================================
// SEÇÃO 6: ORGANIZAÇÃO - COMPANY DATA
// ============================================

model OrganizationCompany {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String       @unique @db.Uuid
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  cnpj            String  @unique
  razaoSocial     String
  nomeFantasia    String?
  cnaeCode        String
  cnaeDescription String
  municipio       String
  uf              String  @db.Char(2)

  tipo             String?
  porte            String?
  naturezaJuridica String?
  capitalSocial    Decimal?
  situacao         String?
  dataAbertura     DateTime?
  dataSituacao     DateTime?
  simplesOptante   Boolean   @default(false)
  simeiOptante     Boolean   @default(false)

  logradouro  String?
  numero      String?
  complemento String?
  bairro      String?
  cep         String?

  email    String?
  telefone String?

  qsa                   Json?
  atividadesSecundarias Json?

  authorizedByUserId String @db.Uuid
  authorizedAt       DateTime @default(now())

  fetchedAt DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([cnaeCode])
  @@index([porte])
  @@index([uf])
  @@index([situacao])
  @@map("organization_companies")
}

// ============================================
// SEÇÃO 7: WHATSAPP & META CONFIG
// ============================================

model WhatsAppConfig {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String @db.Uuid
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  connectionId String? @db.Uuid
  connection   WhatsAppConnection? @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  wabaId        String? // WABA ID (pode repetir se tivermos múltiplos números na mesma linha ou linhas diferentes para mesma WABA)
  phoneId       String?   @unique // Phone Number ID (único no sistema)
  accessToken   String? // System User Access Token (Meta Graph API) - ENCRYPTED
  displayPhone  String? // Número formatado para exibição (ex: +55 11 91234-5678)
  verifiedName  String? // Nome verificado do negócio na Meta
  status                String    @default("pending") // pending, connected, disconnected
  authorizationCode     String? // OAuth authorization code from Embedded Signup
  accessTokenEncrypted  Boolean   @default(false) // Whether the accessToken is encrypted (AES-256-GCM)
  tokenExpiresAt        DateTime? // When the accessToken expires (if not permanent)
  tokenLastCheckedAt    DateTime? // Last time token health was verified via debug_token
  tokenStatus           String?   // valid, expiring_soon, expired, invalid
  connectedAt           DateTime? // Quando foi conectado
  disconnectedAt        DateTime? // Quando foi desconectado
  disconnectedBy        String? @db.Uuid   // User ID que desconectou
  lastWebhookAt         DateTime? // Último evento recebido (detecta integrações mortas)

  // DLQ Fields
  processed       Boolean  @default(false)
  processingError String?
  retryCount      Int      @default(0)

  // History Sync - PRD: WhatsApp History Sync
  historySyncStatus      String?  // 'not_supported' | 'pending_consent' | 'pending_history' | 'syncing' | 'completed' | 'declined' | 'failed'
  historySyncStartedAt   DateTime?
  historySyncCompletedAt DateTime?
  historySyncProgress    Int      @default(0) // 0-100
  historySyncPhase       Int?
  historySyncChunkOrder  Int?
  historySyncError       String?

  messages Message[]
  conversations Conversation[]
  historySyncs WhatsAppHistorySync[] @relation("HistorySyncs")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([connectionId])
  @@index([processed])
  @@index([historySyncStatus])
  @@map("whatsapp_configs")
}

model WhatsAppOnboarding {
  id             String                      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String @db.Uuid
  organization   Organization               @relation("WhatsAppOnboardings", fields: [organizationId], references: [id], onDelete: Cascade)

  // OAuth Flow
  trackingCode      String @unique
  authorizationCode String?

  // Onboarding Status
  status      String @default("pending")
  statusRef   WhatsAppOnboardingStatus @relation(fields: [status], references: [name])
  initiatedAt DateTime                 @default(now())
  authorizedAt DateTime?
  completedAt DateTime?
  expiresAt   DateTime

  // Meta WABA Info
  wabaId          String?
  ownerBusinessId String?
  phoneNumberId   String?

  // Error Tracking
  errorMessage String?
  errorCode    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([trackingCode])
  @@index([status])
  @@index([expiresAt])
  @@map("whatsapp_onboarding")
}

model WhatsAppConnection {
  id             String                    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String @db.Uuid
  organization   Organization             @relation("WhatsAppConnections", fields: [organizationId], references: [id], onDelete: Cascade)

  // Meta WABA Identifiers
  wabaId          String
  ownerBusinessId String?
  phoneNumberId   String?

  // Connection Status
  status           String @default("pending")
  statusRef        WhatsAppConnectionStatus @relation(fields: [status], references: [name])
  connectedAt      DateTime?
  disconnectedAt   DateTime?

  // Health and Monitoring
  lastWebhookAt    DateTime?
  lastHealthCheckAt DateTime?
  healthStatus     String @default("unknown")
  healthStatusRef  WhatsAppHealthStatus @relation("ConnectionHealthStatus", fields: [healthStatus], references: [name])

  configs WhatsAppConfig[]
  healthChecks WhatsAppHealth[]
  auditLogs WhatsAppAuditLog[] @relation("AuditLogs")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, wabaId])
  @@index([status])
  @@index([phoneNumberId])
  @@map("whatsapp_connections")
}

model WhatsAppHealth {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String @db.Uuid
  organization   Organization @relation("WhatsAppHealthChecks", fields: [organizationId], references: [id], onDelete: Cascade)

  connectionId String @db.Uuid
  connection   WhatsAppConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  // Health Status
  status String // healthy, warning, error, unknown
  statusRef WhatsAppHealthStatus @relation("HealthStatus", fields: [status], references: [name])

  // Token Validation
  tokenValid   Boolean?
  tokenExpired Boolean?
  apiResponse  String? // Last API response/error

  // Metrics
  responseTime Int? // milliseconds
  lastCheck    DateTime @default(now())

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([connectionId])
  @@index([status])
  @@index([lastCheck])
  @@map("whatsapp_health")
}

model WhatsAppWebhookLog {
  id             String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String? @db.Uuid
  organization   Organization? @relation("WhatsAppWebhookLogs", fields: [organizationId], references: [id], onDelete: Cascade)

  payload   Json // The raw JSON received from Meta
  eventType String? // e.g., "messages", "statuses", "template_approval"

  // DLQ Fields
  processed        Boolean    @default(false)
  signatureValid   Boolean?
  processingError  String?
  processedAt      DateTime?
  retryCount       Int        @default(0)
  lastRetryAt      DateTime?

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([processed])
  @@index([createdAt])
  @@index([processed, createdAt])
  @@map("whatsapp_webhook_logs")
}

model WhatsAppAuditLog {
  id             String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String                   @db.Uuid
  organization   Organization             @relation("WhatsAppAuditLogs", fields: [organizationId], references: [id], onDelete: Cascade)

  // Action Details
  action     String
  actionRef  WhatsAppAuditAction @relation(fields: [action], references: [name])
  description String? // Human-readable description
  metadata   Json? // Additional context (wabaId, phoneId, error details, etc)

  // Related Resources
  trackingCode    String? // From WhatsAppOnboarding
  connectionId    String? @db.Uuid
  connection      WhatsAppConnection? @relation("AuditLogs", fields: [connectionId], references: [id], onDelete: SetNull)

  // IP & User Info
  ipAddress       String? // For security auditing
  userAgent       String? // For security auditing

  // Timestamps
  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([action])
  @@index([createdAt])
  @@index([organizationId, createdAt])
  @@index([trackingCode])
  @@index([connectionId])
  @@map("whatsapp_audit_logs")
}

// ============================================
// SEÇÃO 8: WHATSAPP - HISTORY SYNC (PRD)
// ============================================

model WhatsAppHistorySync {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  connectionId   String   @db.Uuid
  connection     WhatsAppConfig @relation("HistorySyncs", fields: [connectionId], references: [id], onDelete: Cascade)

  // Sync Status
  status         String   // 'processing' | 'completed' | 'failed'
  phase          Int?
  chunkOrder     Int?
  progress       Int      @default(0) // 0-100

  // Error Tracking
  errorCode      String?
  errorMessage   String?

  // Timestamps
  lastPayloadAt  DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([connectionId])
  @@index([status])
  @@index([createdAt])
  @@map("whatsapp_history_syncs")
}

model Message {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  wamid String @unique // WhatsApp Message ID

  leadId String @db.Uuid
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  instanceId String @db.Uuid
  instance   WhatsAppConfig @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  conversationId String? @db.Uuid @map("conversation_uuid")
  conversation   Conversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)

  ticketId String? @db.Uuid
  ticket   Ticket? @relation(fields: [ticketId], references: [id], onDelete: SetNull)

  direction String // INBOUND, OUTBOUND
  type      String // text, image, document, audio, video, etc.
  body      String? @db.Text // Text content or Caption
  mediaUrl  String? // Internal URL for media
  status    String // sent, delivered, read, failed

  timestamp      DateTime // When the message was created/received
  metaConversationId String? @map("conversationId") // Meta conversation ID for billing

  // Source Tracking - PRD: History Sync
  source    String  @default("live") // 'live' | 'history' | 'app_echo'
  rawMeta   Json?   // Raw payload from Meta webhook

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([leadId])
  @@index([instanceId])
  @@index([conversationId])
  @@index([ticketId])
  @@index([source])
  @@index([timestamp])
  @@map("whatsapp_messages")
}
