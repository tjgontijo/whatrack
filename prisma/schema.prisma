generator client {
  provider        = "prisma-client-js"
  output          = "./generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [pgcrypto]
}

model UserRole {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String   @unique
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  users       User[]

  @@map("user_roles")
}

model OnboardingStatus {
  id          String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String                @unique
  description String
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  profiles    OrganizationProfile[]

  @@map("onboarding_statuses")
}

model SaleStatus {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String   @unique
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  sales       Sale[]

  @@map("sale_statuses")
}

model WhatsAppOnboardingStatus {
  id          String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String               @unique
  description String
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  onboardings WhatsAppOnboarding[]

  @@map("whatsapp_onboarding_statuses")
}

model WhatsAppConnectionStatus {
  id          String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String               @unique
  description String
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  connections WhatsAppConnection[]

  @@map("whatsapp_connection_statuses")
}

model WhatsAppHealthStatus {
  id           String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String               @unique
  description  String
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  connections  WhatsAppConnection[] @relation("ConnectionHealthStatus")
  healthChecks WhatsAppHealth[]     @relation("HealthStatus")

  @@map("whatsapp_health_statuses")
}

model WhatsAppAuditAction {
  id          String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String             @unique
  description String
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  auditLogs   WhatsAppAuditLog[]

  @@map("whatsapp_audit_actions")
}

model User {
  id              String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name            String
  email           String       @unique
  phone           String?      @unique
  emailVerified   Boolean?     @default(true)
  image           String?
  role            String       @default("user")
  banned          Boolean      @default(false)
  banReason       String?
  banExpires      DateTime?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @default(now()) @updatedAt
  accounts        Account[]
  invitations     Invitation[]
  members         Member[]
  sessions        Session[]
  assignedTickets Ticket[]     @relation("TicketAssignee")
  roleRef         UserRole     @relation(fields: [role], references: [name])

  @@map("user")
}

model Session {
  id                   String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  expiresAt            DateTime
  token                String   @unique
  ipAddress            String?
  userAgent            String?
  impersonatedBy       String?
  userId               String   @db.Uuid
  createdAt            DateTime @default(now())
  updatedAt            DateTime @default(now()) @updatedAt
  activeOrganizationId String?  @db.Uuid
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  accountId             String
  providerId            String
  userId                String    @db.Uuid
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @default(now()) @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

model Organization {
  id                   String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                 String
  slug                 String               @unique
  logo                 String?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  conversations        Conversation[]
  invitations          Invitation[]
  leads                Lead[]
  members              Member[]
  company              OrganizationCompany?
  profile              OrganizationProfile?
  productCategories    ProductCategory[]
  products             Product[]
  saleItems            SaleItem[]
  sales                Sale[]
  ticketStages         TicketStage[]
  tickets              Ticket[]
  whatsappAuditLogs    WhatsAppAuditLog[]   @relation("WhatsAppAuditLogs")
  whatsappConfig       WhatsAppConfig[]
  whatsappConnections  WhatsAppConnection[] @relation("WhatsAppConnections")
  whatsappHealthChecks WhatsAppHealth[]     @relation("WhatsAppHealthChecks")
  whatsappOnboardings  WhatsAppOnboarding[] @relation("WhatsAppOnboardings")
  webhookLogs          WhatsAppWebhookLog[] @relation("WhatsAppWebhookLogs")

  @@map("organization")
}

model Member {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String       @db.Uuid
  userId         String       @db.Uuid
  role           String
  createdAt      DateTime
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("member")
}

model Invitation {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String       @db.Uuid
  email          String
  role           String?
  status         String
  expiresAt      DateTime
  inviterId      String       @db.Uuid
  user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("invitation")
}

model Lead {
  id             String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String         @db.Uuid
  name           String?
  mail           String?
  phone          String?
  waId           String?        @map("remote_jid")
  pushName       String?
  profilePicUrl  String?
  lastMessageAt  DateTime?      @map("last_message_at")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @default(now()) @updatedAt @map("updated_at")
  source         String         @default("direct_creation")
  lastSyncedAt   DateTime?
  isActive       Boolean        @default(true)
  deletedAt      DateTime?
  conversations  Conversation[]
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  messages       Message[]

  @@unique([organizationId, phone])
  @@unique([organizationId, waId])
  @@index([organizationId])
  @@index([source])
  @@index([isActive])
  @@map("leads")
}

model Conversation {
  id                 String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId     String         @db.Uuid
  leadId             String         @db.Uuid
  instanceId         String         @db.Uuid
  metaConversationId String?
  messagesCount      Int            @default(0)
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  instance           WhatsAppConfig @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  lead               Lead           @relation(fields: [leadId], references: [id], onDelete: Cascade)
  organization       Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  tickets            Ticket[]
  messages           Message[]

  @@unique([leadId, instanceId])
  @@index([organizationId])
  @@map("conversations")
}

model Ticket {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId  String          @db.Uuid
  conversationId  String          @db.Uuid
  stageId         String          @db.Uuid
  windowExpiresAt DateTime?
  windowOpen      Boolean         @default(true)
  assigneeId      String?         @db.Uuid
  dealValue       Decimal?        @db.Decimal(12, 2)
  status          String          @default("open")
  closedAt        DateTime?
  closedReason    String?
  createdBy       String          @default("SYSTEM")
  messagesCount   Int             @default(0)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  leadId          String
  source          String          @default("incoming_message")
  originatedFrom  String?
  sales           Sale[]
  tracking        TicketTracking?
  assignee        User?           @relation("TicketAssignee", fields: [assigneeId], references: [id])
  conversation    Conversation    @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  organization    Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  stage           TicketStage     @relation(fields: [stageId], references: [id])
  messages        Message[]

  @@index([organizationId])
  @@index([conversationId])
  @@index([status])
  @@index([stageId])
  @@map("tickets")
}

model TicketStage {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String       @db.Uuid
  name           String
  color          String
  order          Int
  isDefault      Boolean      @default(false)
  isClosed       Boolean      @default(false)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  tickets        Ticket[]

  @@unique([organizationId, name])
  @@index([organizationId, order])
  @@map("ticket_stages")
}

model TicketTracking {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ticketId    String   @unique @db.Uuid
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  utmTerm     String?
  utmContent  String?
  gclid       String?
  fbclid      String?
  ctwaclid    String?
  ttclid      String?
  sourceType  String   @default("organic")
  referrerUrl String?
  landingPage String?
  userAgent   String?
  ipAddress   String?
  createdAt   DateTime @default(now())
  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([utmSource])
  @@index([sourceType])
  @@index([ctwaclid])
  @@map("ticket_tracking")
}

model Sale {
  id              String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId  String       @db.Uuid
  totalAmount     Decimal?     @db.Decimal(12, 2)
  profit          Decimal?     @db.Decimal(12, 2)
  discount        Decimal?     @db.Decimal(12, 2)
  status          String?      @default("pending")
  notes           String?
  createdBy       String?
  updatedBy       String?
  statusChangedAt DateTime?
  ticketId        String?      @db.Uuid
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @default(now()) @updatedAt
  items           SaleItem[]
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  statusRef       SaleStatus?  @relation(fields: [status], references: [name])
  ticket          Ticket?      @relation(fields: [ticketId], references: [id])

  @@index([organizationId])
  @@index([createdAt])
  @@index([ticketId])
  @@map("sales")
}

model SaleItem {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String       @db.Uuid
  saleId         String       @db.Uuid
  productId      String?      @db.Uuid
  name           String
  quantity       Int          @default(1)
  unitPrice      Decimal      @db.Decimal(12, 2)
  total          Decimal      @db.Decimal(12, 2)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now()) @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  product        Product?     @relation(fields: [productId], references: [id])
  sale           Sale         @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([saleId])
  @@index([productId])
  @@map("sale_items")
}

model Product {
  id             String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String           @db.Uuid
  categoryId     String?          @db.Uuid
  name           String
  price          Decimal?         @db.Decimal(12, 2)
  cost           Decimal?         @db.Decimal(12, 2)
  active         Boolean          @default(true)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @default(now()) @updatedAt
  category       ProductCategory? @relation(fields: [categoryId], references: [id])
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  saleItems      SaleItem[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([active])
  @@map("products")
}

model ProductCategory {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String       @db.Uuid
  name           String
  active         Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now()) @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  products       Product[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([active])
  @@map("product_categories")
}

model OrganizationProfile {
  id                      String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId          String           @unique @db.Uuid
  cpf                     String?          @unique
  onboardingStatus        String           @default("pending")
  onboardingCompletedAt   DateTime?
  avgTicket               String?
  attendantsCount         String?
  mainChannel             String?
  leadsPerDay             String?
  monthlyRevenue          String?
  monthlyAdSpend          String?
  estimatedConversionRate Float?
  estimatedCPL            Float?
  estimatedCAC            Float?
  estimatedROAS           Float?
  estimatedLeadValue      Float?
  leadsPerAttendant       Float?
  revenuePerAttendant     Float?
  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt
  onboardingStatusRef     OnboardingStatus @relation(fields: [onboardingStatus], references: [name])
  organization            Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("organization_profiles")
}

model OrganizationCompany {
  id                    String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId        String       @unique @db.Uuid
  cnpj                  String       @unique
  razaoSocial           String
  nomeFantasia          String?
  cnaeCode              String
  cnaeDescription       String
  municipio             String
  uf                    String       @db.Char(2)
  tipo                  String?
  porte                 String?
  naturezaJuridica      String?
  capitalSocial         Decimal?
  situacao              String?
  dataAbertura          DateTime?
  dataSituacao          DateTime?
  simplesOptante        Boolean      @default(false)
  simeiOptante          Boolean      @default(false)
  logradouro            String?
  numero                String?
  complemento           String?
  bairro                String?
  cep                   String?
  email                 String?
  telefone              String?
  qsa                   Json?
  atividadesSecundarias Json?
  authorizedByUserId    String       @db.Uuid
  authorizedAt          DateTime     @default(now())
  fetchedAt             DateTime     @default(now())
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  organization          Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([cnaeCode])
  @@index([porte])
  @@index([uf])
  @@index([situacao])
  @@map("organization_companies")
}

model WhatsAppConfig {
  id                      String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId          String              @db.Uuid
  connectionId            String?             @db.Uuid
  wabaId                  String?
  phoneId                 String?             @unique
  accessToken             String?
  displayPhone            String?
  verifiedName            String?
  status                  String              @default("pending")
  authorizationCode       String?
  accessTokenEncrypted    Boolean             @default(false)
  tokenExpiresAt          DateTime?
  tokenLastCheckedAt      DateTime?
  tokenStatus             String?
  connectedAt             DateTime?
  disconnectedAt          DateTime?
  disconnectedBy          String?             @db.Uuid
  lastWebhookAt           DateTime?
  processed               Boolean             @default(false)
  processingError         String?
  retryCount              Int                 @default(0)
  historySyncStatus       String?
  historySyncStartedAt    DateTime?
  historySyncCompletedAt  DateTime?
  historySyncProgress     Int                 @default(0)
  historySyncPhase        Int?
  historySyncChunkOrder   Int?
  historySyncError        String?
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt
  conversations           Conversation[]
  connection              WhatsAppConnection? @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  organization            Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  messages                Message[]

  @@index([connectionId])
  @@index([processed])
  @@index([historySyncStatus])
  @@map("whatsapp_configs")
}

model WhatsAppOnboarding {
  id                String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId    String                   @db.Uuid
  trackingCode      String                   @unique
  authorizationCode String?
  status            String                   @default("pending")
  initiatedAt       DateTime                 @default(now())
  authorizedAt      DateTime?
  completedAt       DateTime?
  expiresAt         DateTime
  wabaId            String?
  ownerBusinessId   String?
  phoneNumberId     String?
  errorMessage      String?
  errorCode         String?
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt
  organization      Organization             @relation("WhatsAppOnboardings", fields: [organizationId], references: [id], onDelete: Cascade)
  statusRef         WhatsAppOnboardingStatus @relation(fields: [status], references: [name])

  @@index([organizationId])
  @@index([trackingCode])
  @@index([status])
  @@index([expiresAt])
  @@map("whatsapp_onboarding")
}

model WhatsAppConnection {
  id                String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId    String                   @db.Uuid
  wabaId            String
  ownerBusinessId   String?
  phoneNumberId     String?
  status            String                   @default("pending")
  connectedAt       DateTime?
  disconnectedAt    DateTime?
  lastWebhookAt     DateTime?
  lastHealthCheckAt DateTime?
  healthStatus      String                   @default("unknown")
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt
  auditLogs         WhatsAppAuditLog[]       @relation("AuditLogs")
  configs           WhatsAppConfig[]
  healthStatusRef   WhatsAppHealthStatus     @relation("ConnectionHealthStatus", fields: [healthStatus], references: [name])
  organization      Organization             @relation("WhatsAppConnections", fields: [organizationId], references: [id], onDelete: Cascade)
  statusRef         WhatsAppConnectionStatus @relation(fields: [status], references: [name])
  healthChecks      WhatsAppHealth[]

  @@unique([organizationId, wabaId])
  @@index([status])
  @@index([phoneNumberId])
  @@map("whatsapp_connections")
}

model WhatsAppHealth {
  id             String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String               @db.Uuid
  connectionId   String               @db.Uuid
  status         String
  tokenValid     Boolean?
  tokenExpired   Boolean?
  apiResponse    String?
  responseTime   Int?
  lastCheck      DateTime             @default(now())
  createdAt      DateTime             @default(now())
  connection     WhatsAppConnection   @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  organization   Organization         @relation("WhatsAppHealthChecks", fields: [organizationId], references: [id], onDelete: Cascade)
  statusRef      WhatsAppHealthStatus @relation("HealthStatus", fields: [status], references: [name])

  @@index([organizationId])
  @@index([connectionId])
  @@index([status])
  @@index([lastCheck])
  @@map("whatsapp_health")
}

model WhatsAppWebhookLog {
  id              String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId  String?       @db.Uuid
  payload         Json
  eventType       String?
  processed       Boolean       @default(false)
  signatureValid  Boolean?
  processingError String?
  processedAt     DateTime?
  retryCount      Int           @default(0)
  lastRetryAt     DateTime?
  createdAt       DateTime      @default(now())
  organization    Organization? @relation("WhatsAppWebhookLogs", fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([processed])
  @@index([createdAt])
  @@index([processed, createdAt])
  @@map("whatsapp_webhook_logs")
}

model WhatsAppAuditLog {
  id             String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String              @db.Uuid
  action         String
  description    String?
  metadata       Json?
  trackingCode   String?
  connectionId   String?             @db.Uuid
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime            @default(now())
  actionRef      WhatsAppAuditAction @relation(fields: [action], references: [name])
  connection     WhatsAppConnection? @relation("AuditLogs", fields: [connectionId], references: [id])
  organization   Organization        @relation("WhatsAppAuditLogs", fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([action])
  @@index([createdAt])
  @@index([organizationId, createdAt])
  @@index([trackingCode])
  @@index([connectionId])
  @@map("whatsapp_audit_logs")
}

model WhatsAppHistorySync {
  id            String    @id
  connectionId  String
  status        String
  phase         Int?
  chunkOrder    Int?
  progress      Int       @default(0)
  errorCode     String?
  errorMessage  String?
  lastPayloadAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt

  @@map("whatsapp_history_syncs")
}

model Message {
  id                 String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  wamid              String         @unique
  leadId             String         @db.Uuid
  instanceId         String         @db.Uuid
  conversationId     String?        @map("conversation_uuid") @db.Uuid
  ticketId           String?        @db.Uuid
  direction          String
  type               String
  body               String?
  mediaUrl           String?
  status             String
  timestamp          DateTime
  metaConversationId String?        @map("conversationId")
  source             String         @default("live")
  rawMeta            Json?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  conversation       Conversation?  @relation(fields: [conversationId], references: [id])
  instance           WhatsAppConfig @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  lead               Lead           @relation(fields: [leadId], references: [id], onDelete: Cascade)
  ticket             Ticket?        @relation(fields: [ticketId], references: [id])

  @@index([leadId])
  @@index([instanceId])
  @@index([conversationId])
  @@index([ticketId])
  @@index([source])
  @@index([timestamp])
  @@map("whatsapp_messages")
}
