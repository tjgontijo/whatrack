<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste WebSocket Centrifugo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 30px;
        }

        h1 {
            margin-bottom: 20px;
            color: #333;
        }

        .status {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .status.connecting {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .log-entry {
            margin: 3px 0;
            padding: 2px 0;
        }

        .log-entry.info { color: #0066cc; }
        .log-entry.success { color: #00aa00; }
        .log-entry.error { color: #cc0000; }
        .log-entry.data { color: #666666; }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #0066cc;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 13px;
            line-height: 1.6;
        }

        code {
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Teste WebSocket Centrifugo</h1>

        <div class="info-box">
            <strong>Como usar:</strong> Clique em "Conectar" para estabelecer conex√£o WebSocket com o Centrifugo.
            Se conectar com sucesso, voc√™ ver√° mensagens de confirma√ß√£o no log abaixo.
        </div>

        <div id="status" class="status connecting">
            ‚è≥ Aguardando a√ß√£o...
        </div>

        <div class="log" id="log"></div>

        <div class="button-group">
            <button id="connectBtn" onclick="connect()">Conectar</button>
            <button id="subscribeBtn" onclick="subscribeToChannel()" disabled>Se Inscrever</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled>Desconectar</button>
            <button onclick="clearLog()">Limpar Log</button>
        </div>
    </div>

    <script>
        let client = null;
        let subscription = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.textContent = message;
        }

        function setButtonState(connecting, subscribed, disconnected) {
            document.getElementById('connectBtn').disabled = connecting || subscribed;
            document.getElementById('subscribeBtn').disabled = !subscribed || !client;
            document.getElementById('disconnectBtn').disabled = disconnected;
        }

        async function connect() {
            log('Iniciando conex√£o...', 'info');
            updateStatus('‚è≥ Conectando...', 'connecting');
            setButtonState(true, false, true);

            try {
                // Fetch token do backend
                log('Buscando token...', 'info');
                const tokenResponse = await fetch('/api/v1/centrifugo/token');

                if (!tokenResponse.ok) {
                    throw new Error(`Erro ao buscar token: ${tokenResponse.status}`);
                }

                const { token } = await tokenResponse.json();
                log('‚úÖ Token obtido', 'success');
                log(`Token (primeiros 50 chars): ${token.substring(0, 50)}...`, 'data');

                // Verificar estrutura do token
                try {
                    const parts = token.split('.');
                    if (parts.length === 3) {
                        const payload = JSON.parse(atob(parts[1]));
                        log(`Payload: ${JSON.stringify(payload)}`, 'data');
                    }
                } catch (e) {
                    log(`Erro ao decodificar token: ${e.message}`, 'error');
                }

                // Criar cliente Centrifugo
                log('Criando cliente Centrifugo...', 'info');
                const wsUrl = 'wss://centrifugo.whatrack.com/connection/websocket';

                client = new Centrifuge(wsUrl, {
                    token: token
                });

                log(`Conectando a ${wsUrl}...`, 'info');

                // Handlers de conex√£o
                client.on('connected', function(ctx) {
                    log('‚úÖ WebSocket conectado!', 'success');
                    log(`Cliente ID: ${ctx.client}`, 'data');
                    log(`Vers√£o: ${ctx.version}`, 'data');
                    updateStatus('‚úÖ Conectado com sucesso!', 'connected');
                    setButtonState(false, true, false);
                });

                client.on('disconnected', function(ctx) {
                    log('‚ùå WebSocket desconectado', 'error');
                    updateStatus('‚ùå Desconectado', 'error');
                    setButtonState(false, false, true);
                });

                client.on('error', function(ctx) {
                    const errorMsg = ctx.error ? (typeof ctx.error === 'object' ? JSON.stringify(ctx.error) : String(ctx.error)) : 'Erro desconhecido';
                    log(`‚ùå Erro de conex√£o: ${errorMsg}`, 'error');
                    log(`Tipo: ${ctx.type || 'desconhecido'}`, 'error');
                    if (ctx.error && ctx.error.message) {
                        log(`Mensagem: ${ctx.error.message}`, 'error');
                    }
                    updateStatus(`‚ùå Erro: ${errorMsg}`, 'error');
                    setButtonState(false, false, true);
                });

                // Conectar
                log(`URL do WebSocket: ${wsUrl}`, 'data');
                log('Iniciando conex√£o WebSocket...', 'info');
                client.connect();

            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'error');
                updateStatus(`‚ùå Erro: ${error.message}`, 'error');
                setButtonState(false, false, true);
            }
        }

        function subscribeToChannel() {
            if (!client) {
                log('‚ùå N√£o est√° conectado', 'error');
                return;
            }

            try {
                // Extract org ID from token payload
                try {
                    const parts = client._token.split('.');
                    if (parts.length === 3) {
                        const payload = JSON.parse(atob(parts[1].replace(/-/g, '+').replace(/_/g, '/')));
                        const orgId = payload.info?.organizationId || 'teste';
                        const channel = `org:${orgId}:messages`;
                        log(`Se inscrevendo em ${channel}...`, 'info');
                        subscription = client.newSubscription(channel);
                    } else {
                        throw new Error('Invalid token format');
                    }
                } catch (e) {
                    log(`Erro ao extrair org ID do token: ${e.message}`, 'error');
                    log('Usando canal padr√£o: org:teste:messages', 'info');
                    subscription = client.newSubscription('org:teste:messages');
                }

                subscription.on('subscribe', function(ctx) {
                    log('‚úÖ Inscrito no canal!', 'success');
                    log(`Recount: ${ctx.recount}`, 'data');
                    log(`Recovered: ${ctx.recovered}`, 'data');
                });

                subscription.on('publication', function(ctx) {
                    log('üì® Mensagem recebida!', 'success');
                    log(`Dados: ${JSON.stringify(ctx.data)}`, 'data');
                });

                subscription.on('error', function(ctx) {
                    const errorMsg = ctx.error ? (typeof ctx.error === 'object' ? JSON.stringify(ctx.error) : String(ctx.error)) : 'Erro desconhecido';
                    log(`‚ùå Erro na subscri√ß√£o: ${errorMsg}`, 'error');
                });

                subscription.on('unsubscribe', function(ctx) {
                    log('Desinscri√ß√£o do canal', 'info');
                });

                subscription.subscribe();

            } catch (error) {
                log(`‚ùå Erro ao inscrever: ${error.message}`, 'error');
            }
        }

        function disconnect() {
            if (subscription) {
                subscription.unsubscribe();
                subscription = null;
            }

            if (client) {
                client.disconnect();
                client = null;
            }

            log('Desconectado', 'info');
            updateStatus('‚ùå Desconectado', 'error');
            setButtonState(false, false, true);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // Carregamento do script Centrifuge
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/centrifuge@5.5.3/dist/centrifuge.min.js';
        script.onload = () => {
            log('‚úÖ Biblioteca Centrifuge carregada', 'success');
            document.getElementById('connectBtn').disabled = false;
        };
        script.onerror = () => {
            log('‚ùå Erro ao carregar biblioteca Centrifuge', 'error');
        };
        document.head.appendChild(script);
    </script>
</body>
</html>
