version: "3.8"

services:
  ## ==================== CENTRIFUGO ==================== ##
  ## Real-time messaging service
  ## Uses remote Redis (RedisLabs) configured via CENTRIFUGO_REDIS_ADDRESS env var
  centrifugo:
    image: centrifugo/centrifugo:v5
    container_name: whatrack-centrifugo

    networks:
      - redeinterna

    environment:
      # Redis engine configuration (points to RedisLabs)
      - CENTRIFUGO_ENGINE=redis
      - CENTRIFUGO_REDIS_URL=redis://default:BcARL142dbky9bbpUeN6aOz8UA8RZ1G4@redis-13762.crce181.sa-east-1-2.ec2.cloud.redislabs.com:13762

      # HTTP server (Centrifugo binds to 0.0.0.0:8000 by default)

      # API & Auth
      - CENTRIFUGO_API_KEY=${CENTRIFUGO_API_KEY:-7f5a2d9c4e8b1a6f3d0c9e7b2a4f6c1d}
      - CENTRIFUGO_TOKEN_HMAC_SECRET_KEY=${CENTRIFUGO_TOKEN_HMAC_SECRET_KEY:-1a9e5c7b3d4f8a2c6e0b7d9f4a1c3e5b}

      # Admin panel
      - CENTRIFUGO_ADMIN=true
      - CENTRIFUGO_ADMIN_PASSWORD=${CENTRIFUGO_ADMIN_PASSWORD:-3c8a1f6d9b2e7a4c}
      - CENTRIFUGO_ADMIN_SECRET=${CENTRIFUGO_ADMIN_SECRET:-9d2f7a1c5e8b3f6a}

      # CORS - allow all origins (secure this in production)
      - CENTRIFUGO_ALLOWED_ORIGINS=*

      # Logging
      - CENTRIFUGO_LOG_LEVEL=info

    ports:
      - "8000:8000"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/ping"]
      interval: 10s
      timeout: 5s
      retries: 5

    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager

    restart: unless-stopped

    labels:
      - traefik.enable=1
      - traefik.http.routers.centrifugo.rule=Host(`centrifugo.whatrack.com`)
      - traefik.http.routers.centrifugo.entrypoints=websecure
      - traefik.http.routers.centrifugo.priority=1
      - traefik.http.routers.centrifugo.tls.certresolver=letsencryptresolver
      - traefik.http.routers.centrifugo.service=centrifugo
      - traefik.http.services.centrifugo.loadbalancer.server.port=8000

networks:
  redeinterna:
    external: true
    name: redeinterna

# NOTE: Redis is now managed by RedisLabs (cloud service)
# No local Redis container needed
# Centrifugo connects via CENTRIFUGO_REDIS_URL (redis://user:password@host:port)
